<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#fdfdfc" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#0c0a09" media="(prefers-color-scheme: dark)">

    <title>Scriptorium</title>
    
    <link rel="icon" id="dynamic-favicon" type="image/png" href="Día.png">
    <link rel="apple-touch-icon-precomposed" id="dynamic-apple-icon" href="Día.png">

    <!-- Librerías -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        if (window.pdfjsLib) {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/epub.js/0.3.93/epub.min.js"></script>

    <!-- Fuentes -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Merriweather:ital,wght@0,300;0,400;0,700;1,300;1,400&family=Cinzel:wght@600;700&display=swap" rel="stylesheet">

    <style>
        /* --- ESTILOS SCRIPTORIUM 2.0 --- */
        :root {
            --font-ui: 'Inter', system-ui, sans-serif;
            --font-body: 'Merriweather', 'Noto Serif', serif;
            --font-display: 'Cinzel', serif;

            /* Light Theme */
            --bg-app: #fdfdfc; 
            --bg-sidebar: #f7f7f5;
            --bg-panel: #ffffff;
            --bg-input: #f2f2f0;
            --border-subtle: #e5e5e0;
            --border-focus: #d6d3d1;
            
            --text-primary: #292524;
            --text-secondary: #57534e;
            --text-tertiary: #a8a29e;
            
            --accent-primary: #d97706; /* Amber 600 */
            --accent-hover: #b45309;
            --accent-subtle: #fffbeb;
            
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -1px rgb(0 0 0 / 0.03);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.05), 0 4px 6px -2px rgb(0 0 0 / 0.025);
            
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
        }

        /* Tema Oscuro */
        [data-theme='dark'] {
            --bg-app: #0c0a09; --bg-sidebar: #1c1917; --bg-panel: #292524; --bg-input: #1c1917;
            --border-subtle: #44403c; --border-focus: #57534e;
            --text-primary: #e7e5e4; --text-secondary: #a8a29e; --text-tertiary: #57534e;
            --accent-primary: #d97706; --accent-hover: #b45309; --accent-subtle: #451a03;
        }
        /* Tema Cálido */
        [data-theme='warm'] {
            --bg-app: #f5f0e6; --bg-sidebar: #ebe5d5; --bg-panel: #fdfbf7; --bg-input: #e6dfcf;
            --border-subtle: #d6cfbf; --border-focus: #c2baa6;
            --text-primary: #4a3b32; --text-secondary: #756050; --text-tertiary: #a69588;
            --accent-primary: #a05a2c; --accent-hover: #824722; --accent-subtle: #f0e6dd;
        }
        /* Tema Rosa */
        [data-theme='pink'] {
            --bg-app: #fff0f5; --bg-sidebar: #ffe4e9; --bg-panel: #ffffff; --bg-input: #ffeef2;
            --border-subtle: #fbcfe8; --border-focus: #f9a8d4;
            --text-primary: #831843; --text-secondary: #9d174d; --text-tertiary: #db2777;
            --accent-primary: #db2777; --accent-hover: #be185d; --accent-subtle: #fce7f3;
        }

        /* Ajuste clave para iOS: height: 100dvh y scroll behavior */
        body { 
            background-color: var(--bg-app); 
            color: var(--text-primary); 
            font-family: var(--font-ui); 
            transition: background-color 0.3s ease, color 0.3s ease; 
            height: 100vh; 
            height: 100dvh; 
            width: 100vw;
            overflow: hidden;
            overscroll-behavior-y: none; /* Previene el rebote de la app completa */
            -webkit-tap-highlight-color: transparent; /* Elimina flash gris al tocar */
        }
        
        .bg-sidebar { background-color: var(--bg-sidebar); }
        .bg-panel { background-color: var(--bg-panel); }
        .border-theme { border-color: var(--border-subtle); }
        .text-theme-primary { color: var(--text-primary); }
        
        /* Botones Sidebar Desktop */
        .btn-nav {
            display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem;
            border-radius: var(--radius-lg); color: var(--text-secondary); transition: all 0.2s; font-weight: 500;
        }
        .btn-nav:hover { background-color: var(--bg-panel); color: var(--text-primary); transform: translateX(4px); }
        .btn-nav.active { background-color: var(--bg-panel); color: var(--accent-primary); box-shadow: var(--shadow-sm); font-weight: 600; }
        
        /* Botones Navbar Mobile - CORREGIDO */
        .mobile-nav-btn {
            display: flex; 
            flex-direction: column; 
            align-items: center; /* Corregido: antes era items-align */
            justify-content: center;
            gap: 4px; padding: 8px; border-radius: 12px; color: var(--text-secondary); transition: all 0.2s;
        }
        .mobile-nav-btn.active {
            color: var(--accent-primary); background-color: var(--bg-input); font-weight: 600;
        }
        .mobile-nav-btn i { width: 24px; height: 24px; }
        .mobile-nav-btn span { font-size: 10px; font-weight: 500; }

        .editor-paper {
            background-color: var(--bg-panel); box-shadow: var(--shadow-md);
            max-width: 850px; margin: 0 auto; min-height: calc(100vh - 4rem);
            padding: 4rem 5rem; font-family: var(--font-body); font-size: 1.125rem;
            line-height: 1.8; color: var(--text-primary); outline: none; transition: width 0.3s ease;
        }
        
        .format-btn-active {
            background-color: var(--bg-sidebar);
            color: var(--accent-primary) !important;
            box-shadow: inset 0 2px 4px 0 rgb(0 0 0 / 0.05);
        }

        /* --- MODO ENFOQUE --- */
        body.focus-mode #main-sidebar {
            display: none;
        }
        body.focus-mode #editor-toolbar {
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        body.focus-mode #editor-toolbar:hover {
            opacity: 1;
            pointer-events: auto;
        }
        body.focus-mode .editor-paper {
            max-width: 900px;
            box-shadow: none;
            padding-top: 5rem; /* Más espacio arriba */
        }
        
        #view-reader { background-color: var(--bg-app); z-index: 50; }
        
        #pdf-render {
            max-height: 100vh; 
            max-width: 100vw;
            object-fit: contain;
            margin: auto;
        }

        .reader-toolbar {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .reader-toolbar.collapsed {
            transform: translateY(100%);
        }

        .reader-top-anim {
            transition: max-height 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.2s;
        }

        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .pt-safe { padding-top: env(safe-area-inset-top); }
        
        /* Contenedores con scroll nativo suave */
        .overflow-y-auto {
            -webkit-overflow-scrolling: touch;
            overscroll-behavior-y: auto; 
        }

        /* Padding extra para que el contenido no quede debajo de la nav bar móvil */
        .mobile-content-spacer {
            padding-bottom: calc(5rem + env(safe-area-inset-bottom));
        }

        /* Evitar zoom en inputs en iOS */
        input, select, textarea { font-size: 16px !important; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        @media(max-width: 768px) {
            .editor-paper { padding: 2rem 1.5rem; }
        }
    </style>
</head>
<body data-theme="light" class="flex text-sm selection:bg-amber-200 selection:text-amber-900">

    <!-- SIDEBAR (Escritorio) -->
    <aside class="sidebar hidden md:flex w-64 h-full flex-col bg-sidebar border-r border-theme flex-shrink-0 transition-all duration-300 z-30" id="main-sidebar">
        <div class="p-6 pb-2">
            <div class="flex items-center gap-3 mb-6">
                <div class="relative group cursor-pointer" onclick="toggleSettings()">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-amber-500 to-amber-700 flex items-center justify-center text-white shadow-lg shadow-amber-500/20 group-hover:shadow-amber-500/40 transition-all">
                        <i data-lucide="feather" class="w-6 h-6"></i>
                    </div>
                    <div id="ai-status-dot" class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full border-2 border-sidebar" title="IA Desconectada"></div>
                </div>
                <div>
                    <h1 class="font-display font-bold text-lg text-theme-primary tracking-wide leading-tight">Scriptorium</h1>
                    <p class="text-[10px] uppercase tracking-widest text-theme-secondary font-bold opacity-70">Studio</p>
                </div>
            </div>

            <button onclick="clearEditor(); switchView('editor')" class="w-full flex items-center justify-center gap-2 bg-panel border border-theme hover:border-amber-500/50 text-theme-primary py-2.5 rounded-xl shadow-sm hover:shadow-md transition-all group">
                <div class="w-6 h-6 rounded-full bg-amber-100 text-amber-600 flex items-center justify-center group-hover:scale-110 transition-transform"><i data-lucide="plus" class="w-3.5 h-3.5"></i></div>
                <span class="font-semibold text-xs">Nuevo Escrito</span>
            </button>
        </div>

        <nav class="flex-1 overflow-y-auto px-4 py-2 space-y-1">
            <div class="text-[10px] font-bold uppercase tracking-widest text-theme-tertiary px-3 mb-2 mt-2">Espacio</div>
            <button onclick="switchView('home')" id="btn-home" class="btn-nav w-full"><i data-lucide="layout-dashboard" class="w-4 h-4"></i> Inicio</button>
            <button onclick="switchView('editor')" id="btn-editor" class="btn-nav w-full"><i data-lucide="pen-tool" class="w-4 h-4"></i> Editor</button>
            <button onclick="switchView('library')" id="btn-library" class="btn-nav w-full"><i data-lucide="library" class="w-4 h-4"></i> Biblioteca</button>
            
            <div class="text-[10px] font-bold uppercase tracking-widest text-theme-tertiary px-3 mb-2 mt-6">Herramientas</div>
            <button onclick="switchView('mentor')" id="btn-mentor" class="btn-nav w-full"><i data-lucide="sparkles" class="w-4 h-4"></i> Mentor AI</button>
            <button onclick="openReaderMode()" class="btn-nav w-full"><i data-lucide="book-open" class="w-4 h-4"></i> Lector Zen</button>
        </nav>

        <div class="p-4 border-t border-theme bg-opacity-50">
            <div class="flex items-center gap-3 px-1 cursor-pointer hover:opacity-80 transition-opacity" onclick="toggleSettings()">
                <div id="user-avatar" class="w-8 h-8 rounded-full bg-theme-tertiary flex items-center justify-center text-xs text-white font-bold overflow-hidden shadow-sm">U</div>
                <div class="flex-1 min-w-0">
                    <p id="user-name-display" class="text-xs font-bold text-theme-primary truncate">Invitado</p>
                    <p class="text-[10px] text-theme-secondary">Configuración</p>
                </div>
                <i data-lucide="settings-2" class="w-4 h-4 text-theme-tertiary"></i>
            </div>
        </div>
    </aside>

    <!-- CONTENIDO PRINCIPAL -->
    <main class="flex-1 flex flex-col h-full overflow-hidden relative bg-app transition-colors">
        
        <!-- MOBILE HEADER (Optimizado) -->
        <header class="md:hidden flex items-center justify-between p-4 bg-sidebar/95 backdrop-blur border-b border-theme z-20 shrink-0 pt-safe">
            <div class="flex items-center gap-2">
                 <i data-lucide="feather" class="w-5 h-5 text-amber-600"></i>
                 <span id="mobile-page-title" class="font-display font-bold text-theme-primary text-lg">Inicio</span>
            </div>
            <button onclick="toggleSettings()" class="text-theme-secondary p-1 rounded hover:bg-black/5"><i data-lucide="settings" class="w-5 h-5"></i></button>
        </header>

        <!-- 1. VISTA INICIO -->
        <div id="view-home" class="flex-1 overflow-y-auto p-4 md:p-10 space-y-8 animate-fade-in mobile-content-spacer">
            <div class="max-w-5xl mx-auto w-full">
                <header class="mb-10">
                    <p class="text-theme-secondary text-sm font-medium mb-1" id="date-display">...</p>
                    <h2 class="text-3xl md:text-4xl font-body font-bold text-theme-primary">Hola, <span id="welcome-name" class="text-transparent bg-clip-text bg-gradient-to-r from-amber-600 to-orange-600">Escritor</span>.</h2>
                </header>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                    <div class="bg-panel p-5 rounded-2xl border border-theme shadow-sm hover:shadow-md transition-shadow">
                        <div class="flex justify-between items-start mb-2"><span class="text-[10px] uppercase font-bold text-theme-tertiary">Meta Diaria</span><i data-lucide="target" class="w-4 h-4 text-emerald-500"></i></div>
                        <div class="flex items-end gap-1"><span class="text-2xl font-bold text-theme-primary" id="daily-progress">0</span><span class="text-xs text-theme-secondary mb-1">/ <span id="daily-goal-display">500</span></span></div>
                        <div class="w-full bg-sidebar h-1.5 rounded-full mt-3 overflow-hidden"><div id="daily-progress-bar" class="h-full bg-emerald-500 rounded-full transition-all duration-1000 w-0"></div></div>
                    </div>
                    <div class="bg-panel p-5 rounded-2xl border border-theme shadow-sm hover:shadow-md transition-shadow">
                         <div class="flex justify-between items-start mb-2"><span class="text-[10px] uppercase font-bold text-theme-tertiary">Proyectos</span><i data-lucide="folder-open" class="w-4 h-4 text-blue-500"></i></div>
                        <span class="text-2xl font-bold text-theme-primary" id="stat-total-docs">0</span>
                    </div>
                    <div class="bg-panel p-5 rounded-2xl border border-theme shadow-sm hover:shadow-md transition-shadow">
                        <div class="flex justify-between items-start mb-2"><span class="text-[10px] uppercase font-bold text-theme-tertiary">Total Palabras</span><i data-lucide="align-left" class="w-4 h-4 text-amber-500"></i></div>
                       <span class="text-2xl font-bold text-theme-primary" id="stat-total-words">0</span>
                   </div>
                   <div class="bg-gradient-to-br from-amber-500 to-orange-600 p-5 rounded-2xl shadow-lg text-white cursor-pointer hover:scale-[1.02] transition-transform" onclick="clearEditor(); switchView('editor')">
                       <div class="flex flex-col h-full justify-between"><i data-lucide="feather" class="w-6 h-6 mb-2"></i><div><p class="text-xs font-bold opacity-80 uppercase">Acción Rápida</p><p class="font-bold text-lg">Escribir Ahora</p></div></div>
                   </div>
                </div>

                <div class="bg-panel p-8 rounded-2xl border border-theme shadow-sm relative overflow-hidden mb-8 group">
                    <div class="absolute top-0 right-0 p-10 opacity-5 group-hover:opacity-10 transition-opacity transform rotate-12"><i data-lucide="quote" class="w-32 h-32"></i></div>
                    <div id="excerpt-container" class="relative z-10 text-center max-w-2xl mx-auto space-y-4">
                        <h4 id="excerpt-book" class="text-xs font-bold text-amber-600 uppercase tracking-widest">Inspiración</h4>
                        <p id="excerpt-text" class="font-body text-xl md:text-2xl text-theme-primary italic leading-relaxed">"..."</p>
                        <p id="excerpt-author" class="text-sm font-bold text-theme-secondary">...</p>
                        <button onclick="fetchBookExcerpt()" class="absolute right-0 bottom-0 p-2 text-theme-tertiary hover:text-theme-primary transition-colors"><i data-lucide="refresh-cw" class="w-4 h-4"></i></button>
                    </div>
                </div>

                <div class="flex items-center justify-between mb-4"><h3 class="font-bold text-lg text-theme-primary">Proyectos Recientes</h3><button onclick="switchView('library')" class="text-xs font-bold text-amber-600 hover:text-amber-700">Ver todo</button></div>
                <div id="projects-progress-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>
        </div>

        <!-- 2. VISTA EDITOR (CORREGIDO: flex-1 para no ocupar 100% y ocultar nav) -->
        <div id="view-editor" class="hidden flex-1 flex flex-col relative bg-transparent overflow-hidden">
            <div id="editor-toolbar" class="flex-shrink-0 px-4 py-2 border-b border-theme bg-panel flex items-center justify-between z-20">
                <div class="flex items-center gap-3 flex-1 min-w-0">
                    <div class="flex flex-col min-w-0 flex-1 max-w-md group">
                        <input type="text" id="doc-title" class="bg-transparent text-lg font-bold text-theme-primary outline-none placeholder:text-theme-tertiary truncate" placeholder="Título del Escrito...">
                        <div class="flex items-center gap-2 text-xs">
                             <input type="text" id="doc-project" class="bg-transparent text-theme-secondary outline-none w-24 hover:text-amber-600 transition-colors cursor-pointer placeholder:text-theme-tertiary" placeholder="Sin Proyecto" list="projects-datalist">
                             <datalist id="projects-datalist"></datalist>
                             <span class="text-theme-tertiary">•</span>
                             <select id="doc-type-select" class="bg-transparent text-theme-secondary outline-none cursor-pointer appearance-none font-medium hover:text-amber-600"><option value="Borrador">Borrador</option><option value="Capítulo">Capítulo</option><option value="Idea">Idea</option><option value="Personaje">Personaje</option></select>
                        </div>
                    </div>
                </div>

                <!-- Botones formato Desktop -->
                <div class="hidden md:flex items-center bg-sidebar rounded-lg p-1 border border-theme mr-2">
                    <button id="btn-fmt-bold" onclick="format('bold')" class="p-1.5 rounded hover:bg-panel text-theme-secondary hover:text-theme-primary transition-colors" title="Negrita (Ctrl+B)"><i data-lucide="bold" class="w-4 h-4"></i></button>
                    <button id="btn-fmt-italic" onclick="format('italic')" class="p-1.5 rounded hover:bg-panel text-theme-secondary hover:text-theme-primary transition-colors" title="Cursiva (Ctrl+I)"><i data-lucide="italic" class="w-4 h-4"></i></button>
                    <button id="btn-fmt-underline" onclick="format('underline')" class="p-1.5 rounded hover:bg-panel text-theme-secondary hover:text-theme-primary transition-colors" title="Subrayado (Ctrl+U)"><i data-lucide="underline" class="w-4 h-4"></i></button>
                    <div class="w-px h-4 bg-theme-tertiary mx-1"></div>
                    <button onclick="toggleFocusMode()" id="btn-focus-mode" class="p-1.5 rounded hover:bg-panel text-theme-secondary hover:text-theme-primary transition-colors" title="Modo Enfoque (Ctrl+Shift+F)"><i data-lucide="maximize" class="w-4 h-4"></i></button>
                </div>
                
                <div class="flex items-center gap-1">
                    <button onclick="toggleAnalysisPanel()" class="p-2 text-theme-secondary hover:text-emerald-600 hover:bg-sidebar rounded-lg transition-colors" title="Corrector"><i data-lucide="check-circle-2" class="w-4 h-4"></i></button>
                    <button onclick="saveDraft()" class="ml-2 flex items-center gap-2 bg-theme-primary text-bg-panel px-4 py-2 rounded-lg text-xs font-bold hover:opacity-90 transition-all shadow-sm" title="Guardar (Ctrl+S)"><span id="save-status-text">Guardar</span></button>
                </div>
            </div>
            
            <!-- Barra formato Mobile (Scroll Horizontal) -->
            <div class="md:hidden w-full overflow-x-auto flex items-center gap-2 px-4 py-2 border-b border-theme bg-sidebar scrollbar-hide shrink-0">
                 <button onclick="format('bold')" class="p-2 rounded bg-panel border border-theme text-theme-secondary shrink-0"><i data-lucide="bold" class="w-4 h-4"></i></button>
                 <button onclick="format('italic')" class="p-2 rounded bg-panel border border-theme text-theme-secondary shrink-0"><i data-lucide="italic" class="w-4 h-4"></i></button>
                 <button onclick="format('underline')" class="p-2 rounded bg-panel border border-theme text-theme-secondary shrink-0"><i data-lucide="underline" class="w-4 h-4"></i></button>
                 <div class="w-px h-6 bg-theme-tertiary shrink-0"></div>
                 <button onclick="format('justifyLeft')" class="p-2 rounded bg-panel border border-theme text-theme-secondary shrink-0"><i data-lucide="align-left" class="w-4 h-4"></i></button>
                 <button onclick="format('justifyCenter')" class="p-2 rounded bg-panel border border-theme text-theme-secondary shrink-0"><i data-lucide="align-center" class="w-4 h-4"></i></button>
            </div>

            <div class="flex-1 overflow-y-auto relative bg-app scroll-smooth mobile-content-spacer" id="editor-scroller">
                <div class="flex justify-center min-h-full py-8 md:py-12" id="editor-container">
                    <div id="main-editor" class="editor-paper w-full rounded-none md:rounded-sm animate-fade-in" contenteditable="true" spellcheck="false" placeholder="Escribe tu historia aquí..."></div>
                </div>
                <!-- Status bar flotante sobre el teclado/nav -->
                <div class="sticky bottom-0 w-full bg-panel/90 backdrop-blur-sm border-t border-theme px-4 py-2 flex justify-between items-center text-[10px] uppercase font-bold text-theme-tertiary z-10 transition-transform duration-300" id="status-bar">
                    <div class="flex gap-4">
                        <span id="stat-words" class="text-theme-secondary">0 Palabras</span>
                        <span>•</span>
                        <span id="stat-readtime">0 min lectura</span>
                        <span id="stat-unsaved" class="text-amber-500 hidden flex items-center gap-1 ml-2"><div class="w-1.5 h-1.5 rounded-full bg-amber-500 animate-pulse"></div> Sin guardar</span>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="downloadCurrentTxt()" class="hover:text-theme-primary"><i data-lucide="download" class="w-3 h-3"></i></button>
                        <button onclick="copyToClipboard()" class="hover:text-theme-primary"><i data-lucide="copy" class="w-3 h-3"></i></button>
                    </div>
                </div>
            </div>

             <!-- Analysis Panel -->
             <div id="analysis-panel" class="absolute right-0 top-0 h-full w-80 bg-panel shadow-2xl border-l border-theme z-40 transform translate-x-full transition-transform duration-300 flex flex-col">
                <div class="p-4 border-b border-theme flex justify-between items-center bg-sidebar">
                    <h3 class="font-bold text-theme-primary text-xs uppercase flex items-center gap-2"><i data-lucide="search" class="w-4 h-4"></i> Revisión</h3>
                    <button onclick="toggleAnalysisPanel()" class="text-theme-tertiary hover:text-theme-primary"><i data-lucide="x" class="w-4 h-4"></i></button>
                </div>
                <div id="issues-container" class="flex-1 overflow-y-auto p-4 space-y-3 bg-app mobile-content-spacer"><div class="text-center py-10 opacity-50"><p class="text-xs">Ejecuta el análisis para ver sugerencias.</p></div></div>
                <div class="p-4 border-t border-theme bg-panel pb-safe">
                    <button onclick="runGrammarCheck()" class="w-full bg-theme-primary text-bg-panel py-3 rounded-lg text-xs font-bold shadow-md hover:opacity-90 transition-all">Analizar Texto</button>
                </div>
                <div id="ai-loading-overlay" class="absolute inset-0 flex items-center justify-center hidden z-50 flex-col bg-white/80 backdrop-blur-sm"><div class="w-8 h-8 border-2 border-theme border-t-amber-500 rounded-full animate-spin mb-2"></div><span class="text-[10px] font-bold uppercase tracking-widest text-amber-600">Procesando...</span></div>
            </div>
        </div>

        <!-- 3. VISTA BIBLIOTECA (RENOVADA) -->
        <div id="view-library" class="hidden h-full flex flex-col bg-app overflow-hidden">
             <div class="p-6 md:p-10 border-b border-theme bg-panel flex justify-between items-end shrink-0">
                <div><h2 class="text-3xl font-display font-bold text-theme-primary">Biblioteca</h2><p class="text-theme-secondary text-sm mt-1">Archivo de manuscritos.</p></div>
                <div class="flex gap-2 items-center">
                    <button onclick="toggleLibraryMode()" id="btn-trash-toggle" class="btn-nav bg-sidebar cursor-pointer text-xs shadow-sm hover:shadow-md border border-theme hover:text-red-600 group">
                        <i data-lucide="trash-2" class="w-4 h-4"></i> <span id="trash-btn-text">Papelera</span>
                    </button>
                    <div class="w-px h-6 bg-theme-tertiary mx-1"></div>
                    <label class="btn-nav bg-sidebar cursor-pointer text-xs shadow-sm hover:shadow-md border border-theme"><i data-lucide="upload" class="w-4 h-4"></i> Importar<input type="file" class="hidden" accept=".txt,.docx,.pdf" onchange="handleFileUpload(this)"></label>
                    <button onclick="exportFullBackup()" class="btn-nav bg-sidebar text-xs shadow-sm hover:shadow-md border border-theme"><i data-lucide="download" class="w-4 h-4"></i> Backup</button>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-6 md:p-10 bg-app relative mobile-content-spacer">
                <div id="library-header-status" class="hidden mb-6 bg-red-50 text-red-600 border border-red-200 p-4 rounded-xl flex items-center gap-3">
                    <i data-lucide="trash" class="w-5 h-5"></i>
                    <span class="font-bold text-sm">Viendo la Papelera de Reciclaje.</span>
                </div>
                <div id="library-content" class="animate-fade-in pb-20 max-w-7xl mx-auto space-y-12"></div>
            </div>
        </div>

        <!-- 4. VISTA MENTOR AI -->
        <div id="view-mentor" class="hidden h-full flex flex-col bg-panel relative">
             <div class="p-4 border-b border-theme flex justify-between items-center bg-sidebar shrink-0">
                 <div class="flex items-center gap-3">
                     <div class="w-8 h-8 rounded-lg bg-gradient-to-tr from-purple-500 to-indigo-600 flex items-center justify-center text-white shadow-md"><i data-lucide="sparkles" class="w-4 h-4"></i></div>
                     <div><h3 class="font-bold text-theme-primary">Mentor AI</h3><p class="text-[10px] text-theme-secondary">Powered by Gemini</p></div>
                 </div>
                 <div class="flex items-center gap-2">
                    <button onclick="resetMentorChat()" class="p-2 text-theme-secondary hover:text-red-500 transition-colors rounded-lg hover:bg-black/5" title="Reiniciar conversación">
                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                    </button>
                    <button onclick="switchView('home')" class="md:hidden p-2 text-theme-secondary"><i data-lucide="x" class="w-5 h-5"></i></button>
                 </div>
             </div>
             <div id="mentor-messages" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 bg-app mobile-content-spacer">
                 <div class="flex gap-4 max-w-2xl"><div class="w-8 h-8 rounded-full bg-theme-tertiary flex-shrink-0 flex items-center justify-center text-white text-xs">AI</div><div class="bg-panel border border-theme p-4 rounded-2xl rounded-tl-none shadow-sm"><p class="text-sm text-theme-primary">Hola. Soy tu mentor literario. ¿En qué te ayudo hoy?</p></div></div>
             </div>
             <div class="p-4 bg-panel border-t border-theme shrink-0 pb-safe mb-16 md:mb-0">
                 <div class="max-w-3xl mx-auto relative">
                     <textarea id="mentor-input" rows="1" class="w-full bg-sidebar border border-theme rounded-xl px-4 py-3 pr-12 text-sm focus:outline-none focus:ring-2 focus:ring-amber-500/50 transition-all shadow-inner resize-none overflow-hidden" placeholder="Pregunta algo sobre tu historia..." onkeydown="handleMentorInputKey(event)" oninput="this.style.height = ''; this.style.height = Math.min(this.scrollHeight, 120) + 'px'"></textarea>
                     <button onclick="sendMentorMessage()" class="absolute right-2 bottom-2 p-1.5 bg-theme-primary text-bg-panel rounded-lg hover:opacity-90 transition-all shadow-sm mb-1"><i data-lucide="arrow-up" class="w-4 h-4"></i></button>
                 </div>
                 <p class="text-[10px] text-theme-tertiary text-center mt-2">Enter para enviar, Shift+Enter para nueva línea</p>
             </div>
        </div>

        <!-- 5. VISTA READER (LECTOR ZEN FULL SCREEN & DESPLEGABLE) -->
        <div id="view-reader" class="hidden fixed inset-0 z-50 flex flex-col bg-white" tabindex="0">
            <!-- Barra Superior Desplegable -->
            <div id="reader-top-container" class="absolute top-0 left-0 w-full z-50 flex flex-col items-center pointer-events-none">
                <div id="reader-top-content-wrapper" class="w-full bg-panel/95 backdrop-blur border-b border-theme shadow-md pointer-events-auto reader-top-anim overflow-hidden max-h-40">
                    <div class="p-4 flex justify-between items-center pt-8 md:pt-4"> 
                        <button onclick="closeReaderMode()" class="p-2 bg-panel rounded-full shadow-sm text-theme-primary hover:scale-110 transition-transform flex items-center gap-2 px-4 border border-theme hover:bg-sidebar"><i data-lucide="arrow-left" class="w-5 h-5"></i><span class="font-bold text-xs">Volver</span></button>
                        <div class="bg-panel/50 rounded-full px-4 py-2 flex items-center gap-4 border border-theme">
                            <button onclick="setReaderTheme('light')" class="w-4 h-4 rounded-full bg-[#fdf6e3] border border-gray-300 ring-2 ring-transparent hover:ring-amber-400"></button>
                            <button onclick="setReaderTheme('dark')" class="w-4 h-4 rounded-full bg-[#1c1917] border border-gray-600 ring-2 ring-transparent hover:ring-amber-400"></button>
                            <div class="w-px h-4 bg-theme-tertiary"></div>
                            <label class="cursor-pointer text-theme-secondary hover:text-theme-primary flex items-center gap-2" title="Importar PDF/ePub"><i data-lucide="plus-circle" class="w-4 h-4"></i><span class="text-xs font-bold">Importar</span><input type="file" class="hidden" accept=".epub,.pdf" onchange="handleBookImport(this)"></label>
                        </div>
                    </div>
                </div>
                <!-- Botón Toggle Top -->
                <button onclick="toggleReaderTopControls()" class="pointer-events-auto bg-panel border border-theme border-t-0 rounded-b-xl px-4 py-1 shadow-md hover:bg-sidebar transition-colors -mt-[1px] flex items-center gap-2 group">
                     <i id="top-toggle-icon" data-lucide="chevron-up" class="w-3 h-3 text-theme-secondary group-hover:text-theme-primary"></i>
                </button>
            </div>
            
            <!-- Vista Biblioteca Lector -->
            <div id="reader-library-view" class="flex-1 overflow-y-auto p-10 pt-24 bg-stone-50 mobile-content-spacer">
                <div class="max-w-6xl mx-auto">
                    <h2 class="text-4xl font-display font-bold text-theme-primary mb-8 text-center text-stone-800">Lecturas Guardadas</h2>
                    <div id="reader-library-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-8"></div>
                </div>
            </div>
            
            <!-- Vista Contenido Libro -->
            <div id="reader-content-view" class="hidden flex-1 relative h-full bg-white flex items-center justify-center overflow-hidden touch-none outline-none">
                <div id="epub-viewer" class="w-full h-full shadow-2xl max-w-4xl bg-panel reader-safe-area"></div>
                <div id="pdf-container" class="w-full h-full flex items-center justify-center bg-zinc-900 overflow-auto reader-safe-area">
                    <canvas id="pdf-render" class="shadow-2xl"></canvas>
                </div>
                
                <!-- Zonas táctiles invisibles para navegación en Desktop -->
                <div class="absolute inset-y-0 left-0 w-16 cursor-pointer z-40 hover:bg-black/5 transition-colors flex items-center justify-center group hidden md:flex" onclick="readerPrevPage()"><i data-lucide="chevron-left" class="w-8 h-8 opacity-0 group-hover:opacity-50 transition-opacity"></i></div>
                <div class="absolute inset-y-0 right-0 w-16 cursor-pointer z-40 hover:bg-black/5 transition-colors flex items-center justify-center group hidden md:flex" onclick="readerNextPage()"><i data-lucide="chevron-right" class="w-8 h-8 opacity-0 group-hover:opacity-50 transition-opacity"></i></div>
                
                <!-- Barra Inferior Desplegable -->
                <div class="absolute bottom-0 w-full z-50 flex flex-col items-center pb-safe">
                    <button onclick="toggleReaderBottomControls()" class="bg-panel border border-theme border-b-0 rounded-t-lg p-1 shadow-md hover:bg-sidebar transition-colors">
                        <i id="bottom-toggle-chevron" data-lucide="chevron-up" class="w-4 h-4 text-theme-secondary"></i>
                    </button>
                    <div id="reader-bottom-bar" class="reader-toolbar collapsed w-full bg-panel/95 backdrop-blur border-t border-theme p-3 flex justify-center items-center gap-4 shadow-lg">
                        <button onclick="readerPrevPage()" class="p-2 hover:bg-sidebar rounded-full"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                        <div class="flex items-center gap-2">
                             <input type="number" id="page-input" class="w-12 bg-transparent text-center font-bold text-sm outline-none border border-theme rounded p-1 text-theme-primary" value="1" onkeydown="if(event.key==='Enter') jumpToPage(this.value)">
                             <span class="text-xs font-bold text-theme-secondary">/ <span id="total-pages">?</span></span>
                        </div>
                        <button onclick="readerNextPage()" class="p-2 hover:bg-sidebar rounded-full"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Mobile View Modal Preview -->
        <div id="preview-modal" class="hidden fixed inset-0 z-[60] bg-black/50 backdrop-blur-sm flex items-center justify-center p-4">
             <div class="bg-panel w-full max-w-2xl rounded-2xl shadow-2xl border border-theme overflow-hidden h-[80vh] flex flex-col">
                 <div class="p-4 border-b border-theme flex justify-between items-center"><h3 class="font-bold text-theme-primary" id="preview-title">Vista Previa</h3><button onclick="getEl('preview-modal').classList.add('hidden')" class="text-theme-secondary"><i data-lucide="x" class="w-5 h-5"></i></button></div>
                 <div id="preview-content" class="p-8 overflow-y-auto font-body text-theme-primary prose max-w-none"></div>
             </div>
        </div>

        <!-- BARRA NAVEGACIÓN MÓVIL (REAL APP FEEL) -->
        <nav class="md:hidden flex justify-around items-center bg-panel border-t border-theme shrink-0 z-30 pb-safe pt-2">
            <button onclick="switchView('home')" id="mobile-btn-home" class="mobile-nav-btn active flex-1">
                <i data-lucide="home"></i><span>Inicio</span>
            </button>
            <button onclick="switchView('editor')" id="mobile-btn-editor" class="mobile-nav-btn flex-1">
                <i data-lucide="pen-tool"></i><span>Editor</span>
            </button>
            <button onclick="switchView('library')" id="mobile-btn-library" class="mobile-nav-btn flex-1">
                <i data-lucide="library"></i><span>Libros</span>
            </button>
            <button onclick="switchView('mentor')" id="mobile-btn-mentor" class="mobile-nav-btn flex-1">
                <i data-lucide="sparkles"></i><span>Mentor</span>
            </button>
        </nav>

    </main>

    <!-- SETTINGS MODAL -->
    <div id="settings-modal" class="hidden fixed inset-0 z-[60] bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 animate-fade-in">
        <div class="bg-panel w-full max-w-lg rounded-2xl shadow-2xl border border-theme overflow-hidden max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-theme flex justify-between items-center"><h3 class="font-display font-bold text-lg text-theme-primary">Configuración</h3><button onclick="toggleSettings()" class="text-theme-secondary"><i data-lucide="x" class="w-5 h-5"></i></button></div>
            <div class="p-6 space-y-6">
                <div><label class="text-xs font-bold uppercase text-theme-tertiary tracking-widest block mb-3">Tema Visual</label><div class="grid grid-cols-4 gap-3"><button onclick="setTheme('light')" class="h-12 rounded-lg bg-[#fdfdfc] border border-gray-200 hover:ring-2 ring-amber-500 transition-all"></button><button onclick="setTheme('dark')" class="h-12 rounded-lg bg-[#0c0a09] border border-gray-700 hover:ring-2 ring-amber-500 transition-all"></button><button onclick="setTheme('warm')" class="h-12 rounded-lg bg-[#f5f0e6] border border-[#d6cfbf] hover:ring-2 ring-amber-500 transition-all"></button><button onclick="setTheme('pink')" class="h-12 rounded-lg bg-[#fff0f5] border border-[#fbcfe8] hover:ring-2 ring-amber-500 transition-all"></button></div></div>
                <div><label class="text-xs font-bold uppercase text-theme-tertiary tracking-widest block mb-2">Gemini API Key</label><input type="password" id="api-key-input" class="w-full bg-sidebar border border-theme rounded-lg p-3 text-sm focus:ring-2 ring-amber-500/50 outline-none" placeholder="Pegar clave aquí..."></div>
                <div><label class="text-xs font-bold uppercase text-theme-tertiary tracking-widest block mb-2">Perfil</label><input type="text" id="settings-name" class="w-full bg-sidebar border border-theme rounded-lg p-3 text-sm outline-none mb-3" placeholder="Tu Nombre"><label class="flex items-center gap-2 cursor-pointer bg-sidebar p-3 rounded-lg border border-theme hover:bg-panel transition-colors"><i data-lucide="image" class="w-4 h-4 text-theme-secondary"></i><span class="text-xs font-bold text-theme-secondary">Cambiar Avatar</span><input type="file" class="hidden" accept="image/*" onchange="previewSettingsAvatar(this)"></label><img id="settings-avatar-img" class="w-16 h-16 rounded-full mt-3 object-cover hidden shadow-md border border-theme"></div>
                <div><label class="text-xs font-bold uppercase text-theme-tertiary tracking-widest block mb-2">Datos</label><div class="flex gap-2"><button onclick="exportFullBackup()" class="flex-1 bg-panel border border-theme py-2 rounded-lg text-xs font-bold hover:bg-sidebar transition-colors">Exportar ZIP</button><label class="flex-1 bg-panel border border-theme py-2 rounded-lg text-xs font-bold hover:bg-sidebar transition-colors text-center cursor-pointer">Importar ZIP<input type="file" class="hidden" accept=".zip" onchange="importFullBackup(this)"></label></div></div>
            </div>
            <div class="p-4 bg-sidebar border-t border-theme flex justify-end"><button onclick="saveSettings()" class="bg-theme-primary text-bg-panel px-6 py-2 rounded-lg font-bold text-sm shadow-md hover:translate-y-px transition-transform">Guardar</button></div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-6 right-6 z-[70] translate-y-24 transition-transform duration-300"><div class="bg-panel border border-theme text-theme-primary px-4 py-3 rounded-xl shadow-xl flex items-center gap-3"><i data-lucide="info" class="w-5 h-5 text-amber-500"></i><span id="toast-msg" class="text-sm font-medium">Notificación</span></div></div>

    <script>
        // --- CONFIGURACIÓN ---
        const getEl = (id) => document.getElementById(id);
        const editor = getEl('main-editor');
        
        let db = null;
        let currentUser = null;
        let drafts = [];
        let isDirty = false;
        let currentDraftId = null;
        let bookRendition = null;
        let pdfDoc = null;
        let pdfRenderTask = null;
        let readerPage = 1;
        let currentReaderBookId = null;
        let initialWordCount = 0;
        let mentorHistory = []; // HISTORIAL DE CHAT
        let libraryViewMode = 'active'; // active | trash
        
        // Variables para Swipe
        let touchStartX = 0;
        let touchEndX = 0;

        const DB_NAME = 'ScriptoriumDB'; 
        const DB_VERSION = 3;

        const FAMOUS_EXCERPTS = [
            { book: "Cien años de soledad", author: "Gabriel García Márquez", text: "Muchos años después, frente al pelotón de fusilamiento..." },
            { book: "Don Quijote de la Mancha", author: "Miguel de Cervantes", text: "En un lugar de la Mancha, de cuyo nombre no quiero acordarme..." }
        ];

        lucide.createIcons();

        // --- INICIALIZACIÓN ---
        function initApp() {
            const dateOptions = { weekday: 'long', day: 'numeric', month: 'long' };
            getEl('date-display').textContent = new Date().toLocaleDateString('es-ES', dateOptions);
            initDB().then(() => loadInitialData());
            
            // Editor Listeners
            editor.addEventListener('input', handleInput);
            document.addEventListener('selectionchange', updateToolbarState);
            
            // Global Shortcuts Listener
            document.addEventListener('keydown', (e) => {
                // Ctrl + S: Guardar
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    if(!getEl('view-editor').classList.contains('hidden')) saveDraft();
                    else showToast("Solo puedes guardar en el editor");
                }
                // Ctrl + Shift + F: Focus Mode
                if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'f') { // Usamos 'f' para focus
                    e.preventDefault();
                    if(!getEl('view-editor').classList.contains('hidden')) toggleFocusMode();
                }
            });
            
            // Autosave loop
            setInterval(() => { if(isDirty) saveDraft(true); }, 5000);
            
            // --- READER LISTENERS (GLOBALES y ROBUSTOS) ---
            window.addEventListener('keydown', (e) => {
                if(getEl('view-reader').classList.contains('hidden') || getEl('reader-content-view').classList.contains('hidden')) return;
                if(document.activeElement.tagName === 'INPUT') return;
                if(e.key === 'ArrowLeft') readerPrevPage();
                if(e.key === 'ArrowRight') readerNextPage();
            });
            
            document.addEventListener('touchstart', e => {
                 if(getEl('view-reader').classList.contains('hidden')) return;
                 touchStartX = e.changedTouches[0].screenX;
            }, {passive: true});
            
            document.addEventListener('touchend', e => {
                if(getEl('view-reader').classList.contains('hidden')) return;
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
            }, {passive: true});
            
            fetchBookExcerpt();
        }

        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onupgradeneeded = (e) => {
                    const d = e.target.result;
                    if (!d.objectStoreNames.contains('books')) d.createObjectStore('books', { keyPath: 'id' });
                    if (!d.objectStoreNames.contains('drafts')) d.createObjectStore('drafts', { keyPath: 'id' });
                    if (!d.objectStoreNames.contains('user')) d.createObjectStore('user', { keyPath: 'id' });
                };
                request.onsuccess = (e) => { db = e.target.result; resolve(db); };
                request.onerror = (e) => reject(e);
            });
        }

        async function loadInitialData() {
            const userTx = db.transaction(['user'], 'readonly');
            const userReq = userTx.objectStore('user').get('current');
            userReq.onsuccess = () => {
                if (userReq.result) currentUser = userReq.result;
                else currentUser = { id: 'current', name: "Invitado", goal: 500, theme: 'light', apiKey: '' };
                updateUIWithUser();
            };
            const draftsTx = db.transaction(['drafts'], 'readonly');
            const draftsReq = draftsTx.objectStore('drafts').getAll();
            draftsReq.onsuccess = () => {
                if(draftsReq.result) drafts = draftsReq.result.sort((a,b) => b.lastModified - a.lastModified);
                renderHomeStats(); renderLibraryGrid();
            };
        }

        function updateUIWithUser() {
            getEl('user-name-display').textContent = currentUser.name;
            getEl('welcome-name').textContent = currentUser.name;
            getEl('daily-goal-display').textContent = currentUser.goal;
            getEl('settings-name').value = currentUser.name;
            if(getEl('api-key-input')) getEl('api-key-input').value = currentUser.apiKey || '';
            setTheme(currentUser.theme || 'light');
            if(currentUser.avatar) {
                getEl('user-avatar').innerHTML = `<img src="${currentUser.avatar}" class="w-full h-full object-cover">`;
                getEl('settings-avatar-img').src = currentUser.avatar;
                getEl('settings-avatar-img').classList.remove('hidden');
            }
            updateAiStatus();
        }

        // Switch View Optimizado para Mobile
        function switchView(viewName) {
            const titles = { 'home': 'Inicio', 'editor': 'Editor', 'library': 'Biblioteca', 'mentor': 'Mentor AI' };
            const titleEl = getEl('mobile-page-title');
            if(titleEl && titles[viewName]) titleEl.textContent = titles[viewName];

            ['home', 'editor', 'library', 'mentor', 'reader'].forEach(v => {
                const el = getEl(`view-${v}`); if(el) el.classList.add('hidden');
                
                // Desktop
                const btn = getEl(`btn-${v}`); if(btn) btn.classList.remove('active');
                // Mobile
                const mobileBtn = getEl(`mobile-btn-${v}`); if(mobileBtn) mobileBtn.classList.remove('active');
            });
            
            const target = getEl(`view-${viewName}`); if(target) target.classList.remove('hidden');
            
            // Active states
            const btnTarget = getEl(`btn-${viewName}`); if(btnTarget) btnTarget.classList.add('active');
            const mobileBtnTarget = getEl(`mobile-btn-${viewName}`); if(mobileBtnTarget) mobileBtnTarget.classList.add('active');
            
            if(viewName === 'home') renderHomeStats();
            if(viewName === 'library') {
                libraryViewMode = 'active'; // Reset to active when opening library
                renderLibraryGrid();
            }
        }

        // --- EDITOR LOGIC ---
        function toggleFocusMode() {
            document.body.classList.toggle('focus-mode');
            const btn = getEl('btn-focus-mode');
            if(document.body.classList.contains('focus-mode')) {
                btn.classList.add('text-accent-primary');
                showToast("Modo Enfoque activado");
            } else {
                btn.classList.remove('text-accent-primary');
            }
        }

        function handleInput() {
            isDirty = true;
            getEl('stat-unsaved').classList.remove('hidden');
            const text = editor.innerText;
            const words = text.trim() ? text.trim().split(/\s+/).length : 0;
            getEl('stat-words').textContent = `${words} Palabras`;
            getEl('stat-readtime').textContent = `${Math.ceil(words / 200)} min lectura`;
            const currentSessionWords = Math.max(0, words - initialWordCount);
            const goal = currentUser.goal || 500;
            const progress = Math.min(100, (words / goal) * 100);
            getEl('daily-progress').textContent = words;
            if(getEl('daily-progress-bar')) getEl('daily-progress-bar').style.width = `${progress}%`;
        }
        
        function updateToolbarState() {
            if (document.activeElement !== editor) return;
            const commands = ['bold', 'italic', 'underline'];
            commands.forEach(cmd => {
                const isActive = document.queryCommandState(cmd);
                const btn = getEl(`btn-fmt-${cmd}`);
                if (isActive && btn) btn.classList.add('format-btn-active');
                else if (btn) btn.classList.remove('format-btn-active');
            });
        }

        function format(command, value = null) { 
            document.execCommand(command, false, value); 
            editor.focus(); 
            updateToolbarState();
        }

        function saveDraft(silent = false) {
            const text = editor.innerHTML;
            const plainText = editor.innerText;
            const title = getEl('doc-title').value.trim() || "Sin Título";
            if(!plainText.trim() && !title) return;
            const draft = {
                id: currentDraftId || Date.now(),
                title: title, text: text,
                project: getEl('doc-project').value || "General",
                type: getEl('doc-type-select').value,
                date: new Date().toLocaleDateString(),
                preview: plainText.substring(0, 150),
                lastModified: Date.now(),
                deletedAt: null
            };
            if(currentDraftId) { const idx = drafts.findIndex(d => d.id === currentDraftId); if(idx !== -1) drafts[idx] = draft; }
            else { drafts.unshift(draft); currentDraftId = draft.id; }
            const tx = db.transaction(['drafts'], 'readwrite');
            tx.objectStore('drafts').put(draft);
            isDirty = false;
            getEl('stat-unsaved').classList.add('hidden');
            if(!silent) showToast("Borrador guardado correctamente");
        }

        function loadDraft(id) {
            if(isDirty) saveDraft(true);
            const draft = drafts.find(d => d.id === id);
            if(!draft) return;
            if(draft.deletedAt) { showToast("No se puede editar un archivo en la papelera"); return; }
            currentDraftId = draft.id;
            getEl('doc-title').value = draft.title;
            getEl('doc-project').value = draft.project || "";
            getEl('doc-type-select').value = draft.type || "Borrador";
            editor.innerHTML = draft.text;
            initialWordCount = draft.text.replace(/<[^>]*>/g, '').trim().split(/\s+/).length;
            switchView('editor');
            handleInput();
            isDirty = false;
            getEl('stat-unsaved').classList.add('hidden');
        }

        function clearEditor() {
            if(isDirty) saveDraft(true);
            currentDraftId = null;
            getEl('doc-title').value = "";
            editor.innerHTML = "";
            getEl('doc-project').value = "";
            initialWordCount = 0;
            handleInput();
        }

        // --- LIBRARY LOGIC ---
        
        function toggleLibraryMode() {
            libraryViewMode = libraryViewMode === 'active' ? 'trash' : 'active';
            renderLibraryGrid();
        }

        function renderLibraryGrid() {
            const container = getEl('library-content');
            const headerStatus = getEl('library-header-status');
            const trashBtnText = getEl('trash-btn-text');
            const trashBtn = getEl('btn-trash-toggle');

            // Update UI State for Mode
            if(libraryViewMode === 'trash') {
                trashBtnText.textContent = "Ver Biblioteca";
                trashBtn.classList.add('bg-red-50', 'text-red-600', 'border-red-200');
                headerStatus.classList.remove('hidden');
            } else {
                trashBtnText.textContent = "Papelera";
                trashBtn.classList.remove('bg-red-50', 'text-red-600', 'border-red-200');
                headerStatus.classList.add('hidden');
            }

            // Filter drafts based on mode
            let displayDrafts = [];
            if(libraryViewMode === 'trash') {
                displayDrafts = drafts.filter(d => d.deletedAt);
            } else {
                displayDrafts = drafts.filter(d => !d.deletedAt);
            }

            if(displayDrafts.length === 0) {
                const emptyMsg = libraryViewMode === 'trash' ? "La papelera está vacía." : "Tu biblioteca está vacía.";
                container.innerHTML = `<div class="flex flex-col items-center justify-center h-64 text-theme-tertiary"><i data-lucide="${libraryViewMode === 'trash' ? 'trash' : 'feather'}" class="w-12 h-12 mb-4 opacity-20"></i><p>${emptyMsg}</p></div>`;
                lucide.createIcons();
                return;
            }

            // Group by Project (only if active, trash shows flat list or we can group too)
            const projects = {};
            displayDrafts.forEach(d => {
                const p = d.project || "Sin Proyecto";
                if(!projects[p]) projects[p] = [];
                projects[p].push(d);
            });

            let html = '';
            for (const [project, items] of Object.entries(projects)) {
                html += `
                <div class="mb-8">
                    <h3 class="text-xl font-bold text-theme-primary mb-4 flex items-center gap-2"><i data-lucide="folder" class="w-5 h-5 text-amber-500"></i> ${project} <span class="text-xs text-theme-tertiary font-normal">(${items.length})</span></h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        ${items.map(d => {
                            // Conditional Buttons based on mode
                            let actionButtons = '';
                            if(libraryViewMode === 'trash') {
                                actionButtons = `
                                    <button onclick="restoreDraft(${d.id})" class="p-1 hover:text-emerald-500 text-theme-secondary flex items-center gap-1" title="Restaurar"><i data-lucide="rotate-ccw" class="w-4 h-4"></i></button>
                                    <button onclick="permanentDeleteDraft(${d.id})" class="p-1 hover:text-red-600 text-theme-secondary flex items-center gap-1" title="Eliminar Definitivamente"><i data-lucide="x-circle" class="w-4 h-4"></i></button>
                                `;
                            } else {
                                actionButtons = `
                                    <button onclick="previewDraft(${d.id})" class="p-1 hover:text-blue-500" title="Vista Previa"><i data-lucide="eye" class="w-4 h-4"></i></button>
                                    <button onclick="downloadDraftPdf(${d.id})" class="p-1 hover:text-emerald-500" title="Descargar PDF"><i data-lucide="file-down" class="w-4 h-4"></i></button>
                                    <button onclick="loadDraft(${d.id})" class="p-1 hover:text-amber-500" title="Editar"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
                                    <button onclick="deleteDraft(${d.id})" class="p-1 hover:text-red-500" title="Papelera"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                `;
                            }

                            return `
                            <div class="group bg-panel border border-theme rounded-xl p-5 hover:shadow-lg transition-all relative flex flex-col h-64 ${libraryViewMode === 'trash' ? 'opacity-75 hover:opacity-100' : ''}">
                                <div class="cursor-pointer flex-1" onclick="${libraryViewMode === 'active' ? `loadDraft(${d.id})` : ''}">
                                    <h3 class="font-bold text-lg text-theme-primary mb-2 line-clamp-1">${d.title}</h3>
                                    <p class="text-sm text-theme-secondary line-clamp-4 leading-relaxed">${d.preview || 'Sin contenido...'}</p>
                                </div>
                                <div class="pt-4 mt-2 border-t border-theme text-[10px] flex justify-between items-center bg-panel z-10">
                                    <span class="text-theme-tertiary">${d.date}</span>
                                    <div class="flex gap-2">
                                         ${actionButtons}
                                    </div>
                                </div>
                            </div>
                        `}).join('')}
                    </div>
                </div>`;
            }
            container.innerHTML = html;
            lucide.createIcons();
        }

        function previewDraft(id) {
            const d = drafts.find(x => x.id === id);
            if(!d) return;
            getEl('preview-title').textContent = d.title;
            getEl('preview-content').innerHTML = d.text;
            getEl('preview-modal').classList.remove('hidden');
        }

        function downloadDraftPdf(id) {
            const d = drafts.find(x => x.id === id);
            if(!d) return;
            const doc = new jspdf.jsPDF();
            doc.setFont("times", "roman");
            doc.setFontSize(24);
            doc.text(d.title, 20, 30);
            doc.setFontSize(12);
            const textLines = doc.splitTextToSize(d.text.replace(/<[^>]*>/g, '\n'), 170);
            doc.text(textLines, 20, 50);
            doc.save(`${d.title}.pdf`);
            showToast("PDF descargado");
        }

        function deleteDraft(id) {
            if(confirm("¿Mover a papelera?")) {
                const d = drafts.find(x => x.id === id);
                if(d) { 
                    d.deletedAt = Date.now(); 
                    const tx = db.transaction(['drafts'], 'readwrite'); 
                    tx.objectStore('drafts').put(d); 
                    
                    // Si estamos borrando el que está abierto actualmente, limpiar el editor
                    if (currentDraftId === id) {
                        clearEditor();
                    }
                    
                    renderLibraryGrid(); 
                    renderHomeStats(); // Actualizar stats al borrar
                    showToast("Movido a papelera"); 
                }
            }
        }
        
        function restoreDraft(id) {
            const d = drafts.find(x => x.id === id);
            if(d) {
                d.deletedAt = null;
                const tx = db.transaction(['drafts'], 'readwrite');
                tx.objectStore('drafts').put(d);
                renderLibraryGrid();
                renderHomeStats();
                showToast("Archivo restaurado");
            }
        }
        
        function permanentDeleteDraft(id) {
            if(confirm("¿Eliminar definitivamente? Esta acción no se puede deshacer.")) {
                const tx = db.transaction(['drafts'], 'readwrite');
                tx.objectStore('drafts').delete(id);
                tx.oncomplete = () => {
                    // Update local array
                    drafts = drafts.filter(d => d.id !== id);
                    renderLibraryGrid();
                    showToast("Eliminado definitivamente");
                };
            }
        }

        // --- READER MODE LOGIC ---
        function openReaderMode() { 
            getEl('view-reader').classList.remove('hidden'); 
            getEl('reader-library-view').classList.remove('hidden');
            getEl('reader-content-view').classList.add('hidden');
            getEl('view-reader').focus(); 
            renderReaderLibrary(); 
        }
        
        function closeReaderMode() { 
            if (!getEl('reader-content-view').classList.contains('hidden')) {
                if(currentReaderBookId) saveBookProgress();
                getEl('reader-content-view').classList.add('hidden');
                getEl('reader-library-view').classList.remove('hidden');
                if(bookRendition) { try { bookRendition.destroy(); } catch(e){} bookRendition = null; }
                if(pdfDoc) { pdfDoc.destroy(); pdfDoc = null; }
                currentReaderBookId = null;
                renderReaderLibrary();
            } else {
                getEl('view-reader').classList.add('hidden'); 
            }
        }
        
        function handleSwipe() {
            const threshold = 50;
            if (touchEndX < touchStartX - threshold) readerNextPage();
            if (touchEndX > touchStartX + threshold) readerPrevPage();
        }
        
        function toggleReaderBottomControls() {
            const bar = getEl('reader-bottom-bar');
            const icon = getEl('bottom-toggle-chevron');
            if (bar.classList.contains('collapsed')) {
                bar.classList.remove('collapsed');
                icon.setAttribute('data-lucide', 'chevron-down');
            } else {
                bar.classList.add('collapsed');
                icon.setAttribute('data-lucide', 'chevron-up');
            }
            lucide.createIcons();
        }
        
        function toggleReaderTopControls() {
             const wrapper = getEl('reader-top-content-wrapper');
             const icon = getEl('top-toggle-icon');
             if (wrapper.classList.contains('max-h-0')) {
                 wrapper.classList.remove('max-h-0');
                 wrapper.classList.add('max-h-40');
                 wrapper.classList.remove('opacity-0');
                 icon.setAttribute('data-lucide', 'chevron-up');
             } else {
                 wrapper.classList.add('max-h-0');
                 wrapper.classList.remove('max-h-40');
                 wrapper.classList.add('opacity-0');
                 icon.setAttribute('data-lucide', 'chevron-down');
             }
             lucide.createIcons();
        }

        function renderReaderLibrary() {
            if(!db) return;
            const tx = db.transaction(['books'], 'readonly');
            const req = tx.objectStore('books').getAll();
            req.onsuccess = () => {
                const books = req.result;
                const grid = getEl('reader-library-grid');
                if(!books || books.length === 0) { grid.innerHTML = '<p class="col-span-full text-center text-theme-tertiary mt-20">No hay libros importados.</p>'; return; }
                
                grid.innerHTML = books.map(b => {
                    const cover = b.cover ? `<img src="${b.cover}" class="book-cover-img">` : `<div class="w-full h-full flex items-center justify-center bg-gray-200 text-gray-400 font-bold text-xl uppercase">${b.type}</div>`;
                    const progress = b.progress || 0;
                    return `<div class="group relative flex flex-col gap-2 cursor-pointer transform hover:-translate-y-1 transition-transform" onclick="loadBookFromDB(${b.id})"><div class="book-cover-container shadow-sm border border-theme h-48 bg-gray-100 rounded overflow-hidden relative">${cover}<div class="absolute bottom-0 left-0 h-1 bg-emerald-500 transition-all" style="width: ${progress}%"></div><button class="absolute top-2 right-2 bg-white/80 p-1 rounded-full text-red-500 opacity-0 group-hover:opacity-100 transition-opacity" onclick="event.stopPropagation(); deleteBook(${b.id})"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div><h4 class="font-bold text-sm text-center truncate text-theme-primary mt-1">${b.name}</h4><p class="text-xs text-center text-theme-tertiary">${progress}% completado</p></div>`;
                }).join('');
                lucide.createIcons();
            };
        }
        
        function deleteBook(id) {
            if(confirm("¿Eliminar libro?")) {
                const tx = db.transaction(['books'], 'readwrite');
                tx.objectStore('books').delete(id);
                tx.oncomplete = () => renderReaderLibrary();
            }
        }

        function loadBookFromDB(id) { 
             const tx = db.transaction(['books'], 'readonly');
             const req = tx.objectStore('books').get(id);
             req.onsuccess = () => { 
                 const book = req.result; 
                 if(book) {
                     currentReaderBookId = id;
                     const file = new File([book.data], book.name, {type: book.type}); 
                     readerPage = book.currentPage || 1;
                     loadBookFile(file); 
                 }
             };
        }
        
        function loadBookFile(file) {
            getEl('reader-library-view').classList.add('hidden');
            getEl('reader-content-view').classList.remove('hidden');
            
            const epubViewer = getEl('epub-viewer');
            const pdfContainer = getEl('pdf-container');
            
            if(bookRendition) try { bookRendition.destroy(); } catch(e){}
            
            const reader = new FileReader();
            
            if(file.type.includes('pdf') || file.name.endsWith('.pdf')) {
                epubViewer.classList.add('hidden'); pdfContainer.classList.remove('hidden');
                reader.onload = async (e) => {
                    const typedarray = new Uint8Array(e.target.result);
                    pdfDoc = await pdfjsLib.getDocument(typedarray).promise;
                    getEl('total-pages').textContent = pdfDoc.numPages;
                    renderPdfPage(readerPage);
                };
                reader.readAsArrayBuffer(file);
            } else {
                epubViewer.classList.remove('hidden'); pdfContainer.classList.add('hidden');
                reader.onload = (e) => {
                    if(typeof window.ePub !== 'undefined') {
                        const book = window.ePub(e.target.result);
                        bookRendition = book.renderTo("epub-viewer", { width: "100%", height: "100%", flow: "paginated" });
                        bookRendition.display();
                        getEl('total-pages').textContent = "?";
                        getEl('page-input').value = 1;
                    }
                };
                reader.readAsArrayBuffer(file);
            }
        }
        
        function renderPdfPage(num) {
            if(!pdfDoc) return;
            if(num < 1) num = 1;
            if(num > pdfDoc.numPages) num = pdfDoc.numPages;
            readerPage = num;
            getEl('page-input').value = num;
            saveBookProgress();
            pdfDoc.getPage(num).then(page => {
                const canvas = getEl('pdf-render');
                const ctx = canvas.getContext('2d');
                const dpr = window.devicePixelRatio || 1;
                const container = getEl('pdf-container');
                const viewportRaw = page.getViewport({scale: 1});
                const scaleX = (container.clientWidth * 0.98) / viewportRaw.width;
                const scaleY = (container.clientHeight * 0.98) / viewportRaw.height;
                const scale = Math.min(scaleX, scaleY);
                const viewport = page.getViewport({scale: scale});
                canvas.width = Math.floor(viewport.width * dpr);
                canvas.height = Math.floor(viewport.height * dpr);
                canvas.style.width = `${Math.floor(viewport.width)}px`;
                canvas.style.height = `${Math.floor(viewport.height)}px`;
                ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
                if (pdfRenderTask) { pdfRenderTask.cancel(); }
                pdfRenderTask = page.render({canvasContext: ctx, viewport: viewport});
            });
        }
        
        function saveBookProgress() {
            if(!currentReaderBookId || !db) return;
            const tx = db.transaction(['books'], 'readwrite');
            const store = tx.objectStore('books');
            store.get(currentReaderBookId).onsuccess = (e) => {
                const book = e.target.result;
                if(book) {
                    book.currentPage = readerPage;
                    if(pdfDoc) book.progress = Math.round((readerPage / pdfDoc.numPages) * 100);
                    store.put(book);
                }
            };
        }
        
        function jumpToPage(val) {
            const page = parseInt(val);
            if(page && page > 0) {
                if(pdfDoc) renderPdfPage(page);
            }
        }
        
        function readerNextPage() { if(pdfDoc && readerPage < pdfDoc.numPages) renderPdfPage(readerPage+1); else if(bookRendition) bookRendition.next(); }
        function readerPrevPage() { if(pdfDoc && readerPage > 1) renderPdfPage(readerPage-1); else if(bookRendition) bookRendition.prev(); }
        
        function handleBookImport(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                const blob = new Blob([e.target.result], {type: file.type});
                let coverData = null;
                if (file.type.includes('pdf')) {
                    try {
                        const loadingTask = pdfjsLib.getDocument(new Uint8Array(e.target.result));
                        const pdf = await loadingTask.promise;
                        const page = await pdf.getPage(1);
                        const viewport = page.getViewport({scale: 0.5});
                        const canvas = document.createElement('canvas');
                        const context = canvas.getContext('2d');
                        canvas.height = viewport.height; canvas.width = viewport.width;
                        await page.render({canvasContext: context, viewport: viewport}).promise;
                        coverData = canvas.toDataURL();
                    } catch(err) { console.error("Cover error", err); }
                }
                const tx = db.transaction(['books'], 'readwrite');
                tx.objectStore('books').add({
                    id: Date.now(), name: file.name, type: file.type, data: blob, 
                    cover: coverData, progress: 0, currentPage: 1, date: new Date().toLocaleDateString()
                });
                showToast("Libro guardado");
                renderReaderLibrary();
            };
            reader.readAsArrayBuffer(file);
            input.value = '';
        }

        // --- EXTRAS ---
        async function runGrammarCheck() {
            const t = editor.innerText; if(!t) return showToast("Escribe algo primero.");
            getEl('ai-loading-overlay').classList.remove('hidden');
            setTimeout(() => {
                const issues = [{ error: "abia", fix: "había", context: "Ortografía" }];
                renderIssues(issues); getEl('ai-loading-overlay').classList.add('hidden');
            }, 500);
        }
        function renderIssues(issues) { getEl('issues-container').innerHTML = issues.map(i => `<div class="bg-panel p-3 rounded shadow-sm mb-2"><p class="text-red-500 line-through">${i.error}</p><p class="font-bold">${i.fix}</p></div>`).join(''); }
        function fetchBookExcerpt() { 
            const e = FAMOUS_EXCERPTS[Math.floor(Math.random()*FAMOUS_EXCERPTS.length)];
            getEl('excerpt-book').textContent = e.book; getEl('excerpt-author').textContent = e.author; getEl('excerpt-text').textContent = `"${e.text}"`;
        }
        function handleFileUpload(i){
            const f=i.files[0]; if(!f)return;
            const r=new FileReader(); r.onload=e=>{
                const nd={id:Date.now(),title:f.name,text:e.target.result,project:"Importados",type:'Borrador',date:new Date().toLocaleDateString(),preview:e.target.result.substring(0,100),lastModified:Date.now(),deletedAt:null};
                drafts.unshift(nd); const tx=db.transaction(['drafts'],'readwrite'); tx.objectStore('drafts').put(nd); renderHomeStats();
            }; r.readAsText(f);
        }
        function renderHomeStats() {
            // FIX: SOLO CONTAR NO BORRADOS
            const activeDrafts = drafts.filter(d => !d.deletedAt);
            const totalDocs = activeDrafts.length;
            const totalWords = activeDrafts.reduce((acc, d) => acc + (d.text.replace(/<[^>]*>/g,'').split(/\s+/).length || 0), 0);
            getEl('stat-total-docs').textContent = totalDocs;
            getEl('stat-total-words').textContent = totalWords.toLocaleString();
            const container = getEl('projects-progress-container');
            if (container) {
                const recent = activeDrafts.slice(0, 3);
                if (recent.length === 0) {
                     container.innerHTML = '<p class="text-theme-tertiary col-span-full">Aún no has escrito nada.</p>';
                } else {
                    container.innerHTML = recent.map(d => `<div onclick="loadDraft(${d.id})" class="bg-panel p-4 rounded-xl border border-theme hover:border-amber-400 cursor-pointer transition-all"><h4 class="font-bold text-theme-primary truncate">${d.title}</h4><p class="text-xs text-theme-tertiary mt-1">${d.date}</p></div>`).join('');
                }
            }
        }
        function copyToClipboard() { const t = editor.innerText; navigator.clipboard.writeText(t).then(() => showToast("Copiado")); }
        function downloadCurrentTxt() { const blob = new Blob([editor.innerText], {type:'text/plain'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = (getEl('doc-title').value || 'doc') + '.txt'; a.click(); }
        function previewSettingsAvatar(input) { if(input.files[0]) { const reader = new FileReader(); reader.onload = (e) => { currentUser.avatar = e.target.result; getEl('settings-avatar-img').src = e.target.result; getEl('settings-avatar-img').classList.remove('hidden'); }; reader.readAsDataURL(input.files[0]); } }
        function updateAiStatus() { const dot = getEl('ai-status-dot'); if(currentUser.apiKey) { dot.classList.remove('bg-red-500'); dot.classList.add('bg-emerald-500'); } else { dot.classList.add('bg-red-500'); dot.classList.remove('bg-emerald-500'); } }
        
        function setTheme(theme) { 
            document.body.setAttribute('data-theme', theme); 
            if(currentUser) { 
                currentUser.theme = theme; 
                const tx = db.transaction(['user'], 'readwrite'); 
                tx.objectStore('user').put(currentUser); 
            } 
            
            let iconPath = 'Día.png'; 
            switch(theme) {
                case 'dark': iconPath = 'Noche.png'; break;
                case 'warm': iconPath = 'Cálido.png'; break;
                case 'pink': iconPath = 'Pink.png'; break;
                default: iconPath = 'Día.png';
            }
            getEl('dynamic-favicon').href = iconPath;
            getEl('dynamic-apple-icon').href = iconPath;
        }
        
        function showToast(msg) { const t = getEl('toast'); getEl('toast-msg').textContent = msg; t.classList.remove('translate-y-24'); setTimeout(() => t.classList.add('translate-y-24'), 3000); }
        function toggleSettings() { getEl('settings-modal').classList.toggle('hidden'); }
        function toggleAnalysisPanel() { getEl('analysis-panel').classList.toggle('translate-x-full'); }
        function saveSettings() { 
            currentUser.name = getEl('settings-name').value; 
            currentUser.apiKey = getEl('api-key-input').value; 
            const tx = db.transaction(['user'], 'readwrite'); 
            tx.objectStore('user').put(currentUser); 
            updateUIWithUser(); 
            toggleSettings(); 
            showToast("Guardado"); 
        }
        function exportFullBackup() { showToast("Función de backup lista"); } 
        function importFullBackup() {}

        // --- GEMINI AI CON CONTEXTO ---

        async function callGemini(contentsPayload) {
            if(!currentUser.apiKey) {
                showToast("Falta API Key (Configuración)");
                return null;
            }
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${currentUser.apiKey}`;
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: contentsPayload })
                });
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text;
            } catch(e) {
                console.error(e);
                return null;
            }
        }

        function getLibraryContext() {
            let context = "INSTRUCCIONES DEL SISTEMA:\n";
            context += "Actúa como un mentor literario experto en la aplicación 'Scriptorium'. Tu objetivo es ayudar al usuario a escribir mejor, superar bloqueos, desarrollar personajes y mejorar su estilo. Sé empático, conciso y constructivo.\n\n";
            
            // Contexto del archivo actual (Prioridad Alta)
            if (currentDraftId) {
                const curr = drafts.find(d => d.id === currentDraftId);
                // FIX: Validar que no esté borrado
                if (curr && !curr.deletedAt) {
                    context += `--- CONTEXTO: ARCHIVO ACTUALMENTE ABIERTO ---\n`;
                    context += `Título: ${curr.title}\n`;
                    context += `Tipo: ${curr.type}\n`;
                    // Limitar el texto enviado para no saturar tokens si es muy largo (aprox 2000 chars)
                    const cleanText = curr.text.replace(/<[^>]*>/g, '');
                    context += `Contenido (Extracto): ${cleanText.substring(0, 3000)}\n`;
                    context += `----------------------------------------------\n\n`;
                }
            }

            // Contexto general de la biblioteca (Resumen)
            // FIX: Filtrar borrados para el contexto AI
            const activeDrafts = drafts.filter(d => !d.deletedAt);
            if (activeDrafts.length > 0) {
                context += `--- CONTEXTO: OTRAS OBRAS EN LA BIBLIOTECA ---\n`;
                const otherDrafts = activeDrafts.filter(d => d.id !== currentDraftId).slice(0, 5); // Solo los 5 más recientes
                if (otherDrafts.length > 0) {
                    otherDrafts.forEach(d => {
                        context += `- [${d.type}] ${d.title}: ${d.preview.replace(/\n/g, ' ').substring(0, 100)}...\n`;
                    });
                } else {
                    context += "(No hay otros borradores recientes)\n";
                }
                context += `----------------------------------------------\n`;
            }

            return context;
        }

        function resetMentorChat() {
            mentorHistory = [];
            const container = getEl('mentor-messages');
            container.innerHTML = `<div class="flex gap-4 max-w-2xl"><div class="w-8 h-8 rounded-full bg-theme-tertiary flex-shrink-0 flex items-center justify-center text-white text-xs">AI</div><div class="bg-panel border border-theme p-4 rounded-2xl rounded-tl-none shadow-sm"><p class="text-sm text-theme-primary">Hola. Soy tu mentor literario. ¿En qué te ayudo hoy?</p></div></div>`;
            showToast("Conversación reiniciada");
        }

        function handleMentorInputKey(event) {
            if (event.key === 'Enter') {
                if (!event.shiftKey) {
                    // Enter solo = enviar
                    event.preventDefault();
                    sendMentorMessage();
                }
                // Shift+Enter = salto de línea natural (no prevenimos default)
            }
        }

        async function sendMentorMessage() {
            const input = getEl('mentor-input');
            const msg = input.value.trim();
            if(!msg) return;

            // 1. Mostrar mensaje del usuario en UI
            const container = getEl('mentor-messages');
            container.innerHTML += `<div class="flex gap-4 max-w-2xl ml-auto flex-row-reverse"><div class="w-8 h-8 rounded-full bg-theme-tertiary flex items-center justify-center text-white text-xs">Tú</div><div class="bg-panel border border-theme p-4 rounded-2xl rounded-tr-none shadow-sm"><p class="text-sm whitespace-pre-line">${msg}</p></div></div>`;
            input.value = "";
            input.style.height = 'auto'; // Reset height
            container.scrollTop = container.scrollHeight;

            // 2. Mostrar indicador de carga
            const loadId = Date.now();
            container.innerHTML += `<div id="load-${loadId}" class="flex gap-4 max-w-2xl"><div class="w-8 h-8 rounded-full bg-theme-tertiary flex-shrink-0 flex items-center justify-center text-white text-xs animate-pulse">...</div><div class="bg-panel border border-theme p-4 rounded-2xl rounded-tl-none shadow-sm"><p class="text-sm text-theme-secondary">Leyendo tus escritos...</p></div></div>`;
            container.scrollTop = container.scrollHeight;

            // 3. Construir Payload con Contexto + Historial
            // Añadimos el mensaje actual al historial local
            mentorHistory.push({ role: 'user', parts: [{ text: msg }] });

            // Mensaje de sistema "oculto" (inyectado como primer mensaje de usuario o contexto)
            // Para la API de Gemini (stateless), enviamos toda la cadena.
            const systemContextMsg = {
                role: 'user',
                parts: [{ text: getLibraryContext() + "\nIMPORTANTE: A continuación comienza la conversación actual con el usuario. Responde basándote en el contexto anterior si es relevante." }]
            };
            
            const modelAckMsg = {
                role: 'model',
                parts: [{ text: "Entendido. He procesado el contexto de tu biblioteca y tu archivo actual. Estoy listo para ayudarte." }]
            };

            // Combinamos: Contexto Inicial -> Ack del Modelo -> Historial Real de Chat
            const payloadContents = [systemContextMsg, modelAckMsg, ...mentorHistory];

            // 4. Llamada a API
            const reply = await callGemini(payloadContents);
            document.getElementById(`load-${loadId}`).remove();
            
            if(reply) {
                // Guardar respuesta en historial
                mentorHistory.push({ role: 'model', parts: [{ text: reply }] });
                
                const cleanReply = marked.parse(reply);
                container.innerHTML += `<div class="flex gap-4 max-w-2xl animate-fade-in"><div class="w-8 h-8 rounded-full bg-theme-tertiary flex-shrink-0 flex items-center justify-center text-white text-xs">AI</div><div class="bg-panel border border-theme p-4 rounded-2xl rounded-tl-none shadow-sm text-sm text-theme-primary prose prose-sm max-w-none">${cleanReply}</div></div>`;
            } else {
                // Si falla, sacamos el mensaje del usuario del historial para que pueda reintentar limpiamente
                mentorHistory.pop(); 
                showToast("Error conectando con la IA");
            }
            container.scrollTop = container.scrollHeight;
        }

        window.onload = initApp;
    </script>
</body>
</html>
